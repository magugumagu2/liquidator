# AAVE v3 清算ボット仕様書

## 📋 概要

AAVE v3プロトコル向けの高性能自動清算ボット（Rust実装）
- **対象チェーン**: Hyperliquid EVM (1秒ブロック)
- **アーキテクチャ**: Artemis フレームワーク + カスタム統合戦略
- **言語**: Rust
- **パフォーマンス**: 1秒ブロック対応、リアルタイム処理

## 🚀 主要機能

### 1. リアルタイム借り手監視
- **初回スキャン**: 5000ブロックずつ効率的に履歴処理
- **リアルタイムスキャン**: 1秒ブロック毎の即座処理
- **階層管理**: 5段階リスク階層による最適化スキャン
- **借り手総数**: 無制限（メモリ効率設計）

### 2. 清算機会検出
- **健康係数監視**: 1.0未満で清算対象
- **最小利益閾値**: 清算額の0.5%（設定可能）
- **利益計算**: 3つの戦略（固定額、ガス倍数、清算比率）
- **スリッページ保護**: 段階的調整（3%〜50%）

### 3. 統合清算戦略
- **Redis連携**: キューイング + キャッシュ最適化
- **並列処理**: 最大100タスク同時実行
- **バッチ処理**: 効率的なグループ化処理
- **優先度管理**: リスクレベル別優先順位

## ⚙️ 技術仕様

### アーキテクチャ

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Archive RPC   │    │   Write RPC      │    │ Realtime RPC    │
│ (履歴データ取得) │    │ (トランザクション) │    │ (最新ブロック)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                        │
         └──────────────┬─────────────────┬─────────────────┘
                        │                 │
         ┌─────────────────────────────────────────────────┐
         │            Artemis Engine                       │
         │  ┌─────────────┐  ┌────────────┐  ┌──────────┐ │
         │  │TimeCollector│  │AaveStrategy│  │Executor  │ │
         │  └─────────────┘  └────────────┘  └──────────┘ │
         └─────────────────────────────────────────────────┘
                        │
         ┌─────────────────────────────────────────────────┐
         │        統合清算戦略 (Redis + Queue)              │
         │  ┌─────────────┐  ┌────────────┐  ┌──────────┐ │
         │  │PriorityQueue│  │BorrowerMgr │  │CacheMgr  │ │
         │  └─────────────┘  └────────────┘  └──────────┘ │
         └─────────────────────────────────────────────────┘
```

### パフォーマンス設定

#### 開発環境
```rust
MAIN_RPC_TIMEOUT: 3秒
RETRY_DELAY: 500ms
MULTICALL_CHUNK_SIZE: 30
MAX_PARALLEL_TASKS: 75
```

#### 本番環境（サーバー内RPC）
```rust
SERVER_MODE_TIMEOUT: 1秒
SERVER_MODE_RETRY_DELAY: 100ms
SERVER_MULTICALL_CHUNK_SIZE: 50
SERVER_MAX_PARALLEL_TASKS: 100
BUFFER_MULTIPLIER: 2x
```

### 借り手階層システム

| 階層名 | ヘルスファクター範囲 | スキャン間隔 | 並列度 |
|--------|---------------------|-------------|--------|
| クリティカル | < 0.1 | 500ms | 12 |
| 高リスク | 0.1 - 1.0 | 1秒 | 10 |
| 中リスク | 1.0 - 1.2 | 3秒 | 8 |
| 低リスク | 1.2 - 1.5 | 10秒 | 6 |
| 安全 | > 1.5 | 30秒 | 4 |

## 🔧 設定オプション

### コマンドライン引数

```bash
# 基本設定
--archive-rpc <URL>              # アーカイブRPCエンドポイント
--write-rpc <URL>                # 書き込みRPCエンドポイント
--private-key <KEY>              # 秘密鍵
--liquidator-address <ADDRESS>   # 清算コントラクトアドレス
--deployment <TYPE>              # MOCKNET | HYPERLEND

# パフォーマンス設定
--poll-interval-secs <SECONDS>   # ポーリング間隔（デフォルト: 1）
--event-buffer-size <SIZE>       # イベントバッファサイズ（デフォルト: 5M）
--action-buffer-size <SIZE>      # アクションバッファサイズ（デフォルト: 5M）
--backpressure-threshold <PCT>   # バックプレッシャー閾値（デフォルト: 80%）

# 高速化オプション
--turbo-mode                     # 高速化モード有効
--fast-polling                   # 高速ポーリング
--single-block-processing        # 1ブロックずつ処理
```

### 環境変数

```bash
# RPC設定
BACKUP_RPC_URL=https://rpc.hyperlend.finance/archive
# 初回スキャン専用アーカイブRPC（大量データ取得用）
INITIAL_SCAN_ARCHIVE_RPC_URL=https://rpc.hyperlend.finance/archive

# リアルタイムRPC設定（環境に応じて自動選択）
# REALTIME_RPC_URL=http://localhost:3001/evm  # サーバー環境
# REALTIME_RPC_URL=http://5.104.84.211:3001/evm  # 開発環境（自動判定）

# Redis設定（統合戦略用）
REDIS_URL=redis://localhost:6379

# 通知設定
DISCORD_WEBHOOK_URL=<webhook_url>
```

## 💰 利益戦略

### 1. 固定額戦略
```rust
ProfitStrategy::FixedAmount(amount)
// 例: 最低10 USDT0の利益
```

### 2. ガス倍数戦略
```rust
ProfitStrategy::GasMultiplier(1.5)
// ガス代の1.5倍以上の利益
```

### 3. 清算比率戦略
```rust
ProfitStrategy::LiquidationPercentage(0.5)
// 清算額の0.5%以上の利益
```

### スリッページ保護

```rust
// 段階的調整
300 bps (3%)  → 500 bps (5%)
500 bps (5%)  → 1000 bps (10%)
1000 bps (10%) → 2000 bps (20%)
2000 bps (20%) → 3000 bps (30%)
3000 bps (30%) → 5000 bps (50%) // 最大
```

## 🔄 処理フロー

### 1. 初期化フェーズ
1. **設定読み込み**: コマンドライン + 環境変数
2. **RPC接続**: Archive/Write/Realtime RPCの初期化
3. **トークン設定**: 主要6トークンの設定取得
4. **キャッシュ読み込み**: 前回の借り手データ復元
5. **統合戦略**: Redis + Queue システム初期化

### 2. 初回スキャンフェーズ
1. **履歴データ取得**: 5000ブロックずつ効率処理
2. **借り手発見**: Borrow/Supply ログから借り手抽出
3. **状態構築**: 担保・債務関係のマッピング作成
4. **キャッシュ保存**: 中間結果の定期保存

### 3. リアルタイム監視フェーズ
1. **新ブロック検知**: 1秒間隔でブロック監視
2. **ログ取得**: 借入・供給イベントのリアルタイム収集
3. **借り手更新**: 状態変化の即座反映
4. **階層スキャン**: リスクレベル別の並列スキャン

### 4. 清算実行フェーズ
1. **機会検出**: 健康係数 < 1.0 の借り手特定
2. **利益計算**: シミュレーション実行
3. **バリデーション**: 厳格な実行前チェック
4. **トランザクション作成**: 最適なガス価格設定
5. **実行**: メンプールへの送信

## 📊 監視・ログ

### メトリクス
- **借り手総数**: 監視対象の借り手数
- **アットリスク借り手**: ヘルスファクター < 1.2
- **水没借り手**: ヘルスファクター < 1.0
- **ペンディング清算**: 実行中のトランザクション数
- **成功率**: 清算成功/試行比率

### ログレベル
- **INFO**: 基本動作ログ
- **WARN**: 警告・注意事項
- **ERROR**: エラー・失敗
- **DEBUG**: 詳細なデバッグ情報（詳細モード時）

### Discord通知
- 🚨 水没借り手発見
- ⚖️ トランザクション送信判定
- ✅ 清算トランザクション送信
- 📊 定期統計レポート

## 🛡️ リスク管理

### バックプレッシャー制御
- **閾値**: チャネル容量の80%
- **制限動作**: 重要度の高い借り手のみ処理
- **復旧**: 自動的な負荷軽減

### エラーハンドリング
- **RPC障害**: 自動フォールバック（Archive ← → Backup）
- **IOAエラー**: スリッページ段階調整
- **ネットワーク混雑**: ガス価格動的調整
- **メモリ不足**: ガベージコレクション + キャッシュクリア

### セキュリティ
- **検証済みペア**: 100%確実なトークンペアのみ
- **最小清算額**: 0.001 ETH相当以上
- **ガス価格上限**: 動的調整（最大100 Gwei）
- **ノンス管理**: 自動同期 + 強制再同期

## 📈 パフォーマンス最適化

### 1秒ブロック対応
- **タイムアウト短縮**: 800ms以下のレスポンス
- **並列度向上**: 最大100タスク同時実行
- **バッファ拡張**: 本番環境2倍サイズ
- **キャッシュ活用**: Redis + インメモリ最適化

### 高速化モード
```rust
// 通常モード → 高速モード
スキャン間隔: 8秒 → 1秒
並列度: 50 → 100
同時TX数: 10 → 20
階層間隔: 最低500ms
```

## 🔌 依存関係

### 主要ライブラリ
```toml
ethers = "2.0"           # Ethereum ライブラリ
tokio = "1.0"            # 非同期ランタイム
artemis-core = "1.0"     # MEVボットフレームワーク
redis = "0.23"           # Redis クライアント
reqwest = "0.11"         # HTTP クライアント
serde = "1.0"            # シリアライゼーション
tracing = "0.1"          # ログライブラリ
clap = "4.0"             # CLI パーサー
```

### 外部サービス
- **Hyperliquid EVM**: メインネット
- **AAVE v3**: 清算プロトコル
- **Redis**: キュー + キャッシュ
- **Discord**: 通知システム

## 🎯 運用指標

### 目標値
- **レスポンス時間**: < 1秒（1ブロック以内）
- **成功率**: > 95%
- **利益率**: > 0.5%/清算
- **稼働率**: > 99.9%

### 監視項目
- メモリ使用量
- CPU使用率
- ネットワーク遅延
- RPC応答時間
- 清算成功/失敗数
- ガス効率性

---

## 🚀 次期アップデート予定

### v2.0 機能
- [ ] 複数DEX対応（Uniswap V3, SushiSwap）
- [ ] MEV保護（Flashbots統合）
- [ ] 機械学習による利益予測
- [ ] GraphQL API対応
- [ ] Web UI ダッシュボード

### パフォーマンス改善
- [ ] WebSocket接続の最適化
- [ ] より高速なメモリプール
- [ ] GPUアクセラレーション
- [ ] 分散処理対応

---

**最終更新**: 2024年12月
**バージョン**: v1.0
**メンテナー**: magu 